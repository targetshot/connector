<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TargetShot Connect</title>
  <meta name="theme-color" content="#0a0a0a" />
  <link rel="icon" href="{{ request.url_for('static', path='favicon.ico') }}" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@600;700&family=Sora:wght@600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'media',
      theme: {
        extend: {
          colors: {
            ink: { 900: '#0a0a0a', 850: '#0d0d0f', 800: '#111113', 700: '#1a1b1e' },
            accent: { DEFAULT: '#0aa5ff', dark: '#0071e3' }
          },
          letterSpacing: { tightest: '-.02em' }
        }
      }
    }
  </script>
  <style>
    :root { color-scheme: light dark; }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { scroll-behavior: smooth; }
    body {
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      min-width: 320px;
    }
    img, svg { display: block; max-width: 100%; height: auto; }
    .brand-heading { font-family: 'Sora', ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; letter-spacing: -.02em; }
    .brand-sub { font-family: 'Plus Jakarta Sans', ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial; letter-spacing: -.01em; }
    .input-label { display: block; font-weight: 600; font-size: 0.9rem; color: #0f172a; }
    .ts-input {
      width: 100%;
      margin-top: 0.4rem;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.45);
      background: rgba(255, 255, 255, 0.9);
      padding: 0.75rem 1rem;
      font-size: 0.95rem;
      color: #0f172a;
      box-shadow: inset 0 1px 1px rgba(148, 163, 184, 0.15);
      transition: border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }
    .ts-input:focus {
      outline: none;
      border-color: rgba(10, 165, 255, 0.9);
      box-shadow: 0 0 0 4px rgba(10, 165, 255, 0.15);
      background: #ffffff;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.3rem 0.85rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      background: rgba(148, 163, 184, 0.18);
      color: #1f2937;
      border: 1px solid transparent;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.12);
      min-width: 3.4rem;
      text-align: center;
      transition: all 160ms ease;
    }
    .badge.ok {
      background: rgba(74, 222, 128, 0.18);
      border-color: rgba(74, 222, 128, 0.35);
      color: #166534;
      box-shadow: inset 0 0 0 1px rgba(74, 222, 128, 0.25);
    }
    .badge.warn {
      background: rgba(248, 113, 113, 0.18);
      border-color: rgba(248, 113, 113, 0.35);
      color: #991b1b;
      box-shadow: inset 0 0 0 1px rgba(248, 113, 113, 0.25);
    }
    .status-detail {
      display: none;
      margin-top: 0.35rem;
      font-size: 0.72rem;
      line-height: 1.1rem;
      color: #4b5563;
    }
    .status-detail.is-visible {
      display: block;
    }
    .status-detail.status-ok { color: #047857; }
    .status-detail.status-warn { color: #b45309; }
    .status-detail.status-error { color: #dc2626; }
    .dark .status-detail { color: rgba(226, 232, 240, 0.85); }
    .dark .status-detail.status-ok { color: #6ee7b7; }
    .dark .status-detail.status-warn { color: #facc15; }
    .dark .status-detail.status-error { color: #fda4af; }
    .btn-secondary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.65rem 1.2rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(15, 23, 42, 0.95);
      color: #ffffff;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      background: rgba(15, 23, 42, 1);
      box-shadow: 0 16px 34px rgba(15, 23, 42, 0.18);
    }
    .btn-secondary:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(10, 165, 255, 0.28);
    }
    .primary-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.85rem 1.7rem;
      border-radius: 999px;
      border: none;
      font-size: 0.98rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      color: #ffffff;
      background-image: linear-gradient(120deg, #0aa5ff, #6366f1, #7c3aed);
      box-shadow: 0 18px 38px rgba(124, 58, 237, 0.25);
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease;
    }
    .primary-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 42px rgba(124, 58, 237, 0.3);
    }
    .primary-button:focus-visible {
      outline: none;
      box-shadow: 0 0 0 4px rgba(10, 165, 255, 0.28);
    }
    code {
      padding: 0.15rem 0.45rem;
      border-radius: 8px;
      background: rgba(15, 23, 42, 0.08);
      font-size: 0.85rem;
      font-family: 'JetBrains Mono', ui-monospace, SFMono-Regular, SFMono, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    @keyframes update-progress {
      0% { transform: translateX(-60%); }
      100% { transform: translateX(160%); }
    }
    .update-progress-strip {
      width: 45%;
      min-width: 120px;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(10, 165, 255, 0.85), rgba(124, 58, 237, 0.85));
      animation: update-progress 1.35s ease-in-out infinite;
      box-shadow: 0 0 16px rgba(99, 102, 241, 0.25);
    }
    @media (prefers-color-scheme: dark) {
      .input-label { color: #e2e8f0; }
      .ts-input {
        background: rgba(17, 17, 19, 0.72);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: #f8fafc;
        box-shadow: inset 0 1px 1px rgba(15, 23, 42, 0.4);
      }
      .ts-input:focus {
        border-color: rgba(10, 165, 255, 0.9);
        box-shadow: 0 0 0 4px rgba(10, 165, 255, 0.28);
        background: rgba(17, 17, 19, 0.92);
      }
      .btn-secondary {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.18);
        color: #f8fafc;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.45);
      }
      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.16);
        box-shadow: 0 16px 34px rgba(15, 23, 42, 0.55);
      }
      .badge {
        background: rgba(148, 163, 184, 0.16);
        border-color: rgba(148, 163, 184, 0.28);
        color: #f8fafc;
      }
      .badge.ok {
        background: rgba(74, 222, 128, 0.18);
        border-color: rgba(74, 222, 128, 0.45);
        color: rgba(240, 253, 244, 0.95);
      }
      .badge.warn {
        background: rgba(248, 113, 113, 0.18);
        border-color: rgba(248, 113, 113, 0.45);
        color: rgba(255, 241, 242, 0.95);
      }
      code { background: rgba(255, 255, 255, 0.08); }
    }
  </style>
  <script>try { document.documentElement.classList.add('js'); } catch (e) { /* no-op */ }</script>
</head>
<body class="antialiased text-zinc-900 bg-gradient-to-br from-white via-white to-slate-100 dark:from-ink-900 dark:via-ink-900 dark:to-black dark:text-white">
  <div class="relative min-h-screen overflow-hidden">
    <div class="pointer-events-none absolute inset-x-0 top-[-35%] h-[420px] bg-[radial-gradient(65%_65%_at_50%_50%,rgba(34,211,238,0.22),rgba(124,58,237,0)_70%)] opacity-90 dark:opacity-65"></div>
    <div class="pointer-events-none absolute -top-24 left-1/2 h-80 w-80 -translate-x-1/2 rounded-full bg-[radial-gradient(circle,rgba(99,102,241,0.35),rgba(99,102,241,0))] blur-[140px]"></div>

    <div class="relative z-10">
      <header class="px-4 pt-10 md:pt-14">
        <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4">
          <a class="flex items-center gap-3 text-zinc-900 dark:text-white" href="#top">
            <span class="flex h-12 w-12 items-center justify-center rounded-2xl bg-white/80 shadow-lg shadow-cyan-500/20 ring-1 ring-white/60 backdrop-blur dark:bg-white/5 dark:ring-white/10">
              <img src="{{ request.url_for('static', path='logo.svg') }}" alt="TargetShot Logo" class="h-8 w-8" />
            </span>
            <span class="brand-sub text-lg font-semibold">TargetShot Connect</span>
          </a>
          <div class="flex flex-col items-start gap-3 text-sm text-zinc-500 dark:text-zinc-400 sm:flex-row sm:items-center sm:gap-4">
            <p>Daten-Sync (Debezium) · MeytonDB → Cloud-Kafka (Confluent)</p>
            <span class="inline-flex items-center gap-2 rounded-full border border-white/40 bg-white/90 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-zinc-800 shadow-sm shadow-cyan-500/10 supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-white/10 dark:text-white/90">
              <span>Version {{ connect_version }}</span>
              <span class="h-1 w-1 rounded-full bg-accent/80 dark:bg-accent"></span>
              <span>{{ connect_release }}</span>
            </span>
            <p class="text-[0.65rem] uppercase tracking-wide text-zinc-500 dark:text-zinc-400">
              Version &amp; Release werden automatisch aus den GitHub-Releases geladen.
            </p>
            <form method="post" action="/logout" class="sm:ml-auto">
              <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-white/60 bg-white/80 px-4 py-2 text-xs font-semibold uppercase tracking-wide text-zinc-700 shadow-sm transition hover:bg-white/90 hover:text-zinc-900 dark:border-white/10 dark:bg-white/10 dark:text-white/80 dark:hover:bg-white/20">
                Abmelden
              </button>
            </form>
          </div>
        </div>
      </header>

      <main class="px-4 pb-16 pt-10 md:pt-16 lg:pb-24">
        <div class="mx-auto max-w-6xl space-y-12">
          <section class="space-y-8">
            <div>
              <span class="inline-flex items-center gap-2 rounded-full border border-accent/30 bg-accent/10 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-accent-dark dark:border-accent/40 dark:bg-accent/15 dark:text-white/90">TargetShot · Connect UI</span>
              <h1 class="brand-heading mt-6 text-4xl font-extrabold tracking-tight text-zinc-900 sm:text-5xl dark:text-white">Konfiguration &amp; Monitoring<br class="hidden sm:block" /></h1>
              <p class="mt-4 max-w-xl text-base leading-relaxed text-zinc-600 dark:text-zinc-300">Richte TargetShot Connect für dein Vereinsnetz ein, prüfe den Worker-Status und teste die Schnittstellen – alles in einer sicheren UI.</p>
              <div class="mt-6 flex flex-wrap items-center gap-3">
                <a href="{{ docs_url }}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 rounded-full border border-white/60 bg-white/80 px-5 py-2 text-xs font-semibold uppercase tracking-wide text-zinc-700 shadow-sm transition hover:bg-white/90 hover:text-zinc-900 dark:border-white/10 dark:bg-white/10 dark:text-white/80 dark:hover:bg-white/20">
                  Dokumentation öffnen
                </a>
              </div>
            </div>

            <div class="space-y-5 text-sm text-zinc-600 dark:text-zinc-300">
              <div class="flex items-start gap-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-accent/15 font-semibold text-accent-dark dark:bg-accent/25 dark:text-white">1</span>
                <div>
                  <h2 class="brand-sub text-base font-semibold text-zinc-800 dark:text-zinc-100">MeytonDB verbinden</h2>
                  <p>Trage Host, Port und Zugangsdaten deines Vereinsservers ein, damit der Daten-Sync alle Ereignisse erfassen kann.</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-accent/15 font-semibold text-accent-dark dark:bg-accent/25 dark:text-white">2</span>
                <div>
                  <h2 class="brand-sub text-base font-semibold text-zinc-800 dark:text-zinc-100">Cloud-Ziel &amp; Topics prüfen</h2>
                  <p>Hinterlege VereinsID sowie Cloud-API-Key &amp; Secret – Bootstrap &amp; Topics setzt das System automatisch.</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <span class="mt-1 inline-flex h-6 w-6 items-center justify-center rounded-full bg-accent/15 font-semibold text-accent-dark dark:bg-accent/25 dark:text-white">3</span>
                <div>
                  <h2 class="brand-sub text-base font-semibold text-zinc-800 dark:text-zinc-100">Worker kontrollieren</h2>
                  <p>Nutze die Status- und Test-Buttons, um deine Pipeline live zu überwachen und bei Bedarf neu zu starten.</p>
                </div>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
              <button type="button" id="btnWorker" class="btn-secondary">Worker-Status</button>
              <span id="statusBadge" class="badge">…</span>
              <span class="text-xs text-zinc-500 dark:text-zinc-400">Live-Abfrage des aktuellen Sync-Connectors</span>
            </div>
          <div class="mt-4 grid gap-3 grid-cols-2 md:grid-cols-3 xl:grid-cols-6">
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
              <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">MeytonDB</p>
              <div class="mt-2 space-y-1">
                <span id="dbStatusBadge" class="badge" aria-live="polite">…</span>
                <p id="dbStatusMessage" class="status-detail"></p>
              </div>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
                <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Cloud-Ziel</p>
                <div class="mt-2 space-y-1">
                  <span id="confluentStatusBadge" class="badge" aria-live="polite">…</span>
                  <p id="confluentStatusMessage" class="status-detail"></p>
                </div>
              </div>
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
              <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Sync-Connector</p>
              <div class="mt-2 space-y-1">
                <span id="connectorStatusBadge" class="badge" aria-live="polite">…</span>
                <p id="connectorStatusMessage" class="status-detail"></p>
              </div>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
              <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Backup-Puffer</p>
              <div class="mt-2 space-y-1">
                <span id="backupStatusBadge" class="badge" aria-live="polite">…</span>
                <p id="backupStatusMessage" class="status-detail"></p>
              </div>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
              <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Lizenz</p>
              <div class="mt-2 space-y-1">
                <span id="licenseStatusBadge" class="badge" aria-live="polite">…</span>
                <p id="licenseStatusMessage" class="status-detail"></p>
              </div>
            </div>
            <div class="rounded-2xl border border-white/10 bg-white/80 p-4 shadow-sm dark:bg-ink-800/80 dark:border-white/10">
              <p class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Monitoring Agent (Elastic)</p>
              <div class="mt-2 space-y-1">
                <span id="elasticAgentStatusBadge" class="badge" aria-live="polite">…</span>
                <p id="elasticAgentStatusMessage" class="status-detail"></p>
              </div>
            </div>
          </div>
          </section>

          {% if flash_message or error_message %}
          <div class="space-y-3">
            {% if flash_message %}
            <div class="rounded-2xl border border-emerald-200/70 bg-emerald-50/80 px-4 py-3 text-sm font-medium text-emerald-700 shadow-sm dark:border-emerald-400/30 dark:bg-emerald-500/10 dark:text-emerald-200">
              {{ flash_message }}
            </div>
            {% endif %}
            {% if error_message %}
            <div class="rounded-2xl border border-red-200/70 bg-red-50/80 px-4 py-3 text-sm font-medium text-red-700 shadow-sm dark:border-red-500/40 dark:bg-red-500/10 dark:text-red-200">
              {{ error_message }}
            </div>
            {% endif %}
          </div>
          {% endif %}

          <div class="grid gap-7 lg:grid-cols-2">
            <form method="post" action="/save" class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
              <input type="hidden" name="section" value="db" />
              <div>
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">MeytonDB-Verbindung</h2>
                <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Zugangsdaten deiner Vereinsdatenbank für den Sync-Connector.</p>
              </div>
              <div class="grid gap-6 md:grid-cols-2">
                <div>
                  <label class="input-label" for="db_host">DB Host</label>
                  <input id="db_host" name="db_host" class="ts-input" value="{{ data.db_host }}" required />
                </div>
                <div>
                  <label class="input-label" for="db_port">DB Port</label>
                  <input id="db_port" name="db_port" type="number" class="ts-input" value="{{ data.db_port }}" required />
                </div>
              </div>
              <div class="grid gap-6 md:grid-cols-2">
                <div>
                  <label class="input-label" for="db_user">DB User</label>
                  <input id="db_user" name="db_user" class="ts-input" value="{{ data.db_user }}" required />
                </div>
                <div>
                  <label class="input-label" for="db_password">DB Passwort</label>
                  <input id="db_password" name="db_password" type="password" class="ts-input" placeholder="••••••••" value="{{ db_password_placeholder }}" autocomplete="current-password" required />
                  {% if db_password_saved %}
                  <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">Gespeichertes Passwort wird aus Sicherheitsgründen nur als Platzhalter angezeigt.</p>
                  {% endif %}
                </div>
              </div>
              <div class="flex flex-wrap items-center gap-3 pt-1">
                <button type="button" id="btnTestDb" class="btn-secondary">Test DB</button>
                <span id="dbBadge" class="badge">…</span>
              </div>
              <div class="flex flex-wrap gap-3 pt-2">
                <button type="submit" class="primary-button">Datenbank speichern</button>
              </div>
            </form>

          <form method="post" action="/save" class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
            <input type="hidden" name="section" value="confluent" />
            <div class="space-y-4">
              <div>
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Cloud-Ziel (Confluent)</h2>
                  <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">VereinsID plus Cloud-API-Key &amp; Secret genügen – Bootstrap, Topics &amp; Prefix werden automatisch verwaltet.</p>
                </div>
              <div class="rounded-2xl border border-accent/25 bg-accent/10 px-4 py-3 text-sm text-accent-dark shadow-sm dark:border-accent/30 dark:bg-accent/20 dark:text-white/90">
                <div class="font-semibold">Standard-Cluster</div>
                <div class="mt-1 flex flex-col gap-1 text-xs text-zinc-700 dark:text-zinc-200">
                  <span>{{ confluent_cluster_url }}</span>
                  <span>Cluster ID: {{ confluent_cluster_id }}</span>
                </div>
              </div>
              <input type="hidden" id="confluent_bootstrap" name="confluent_bootstrap" value="{{ data.confluent_bootstrap }}" />
            </div>
            <div>
              <label class="input-label" for="verein_id">VereinsID</label>
              <input id="verein_id" name="verein_id" class="ts-input" value="{{ data.verein_id }}" required />
              <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">
                Wird als Topic Prefix und Server ID genutzt. Server Name bleibt {{ data.server_name or default_server_name }}.
              </p>
            </div>
            <div class="grid gap-6 md:grid-cols-2">
              <div>
                <label class="input-label" for="confluent_sasl_username">Cloud-API Key (Confluent)</label>
                <input id="confluent_sasl_username" name="confluent_sasl_username" class="ts-input" value="{{ data.confluent_sasl_username }}" required />
              </div>
                <div>
                  <label class="input-label" for="confluent_sasl_password">Cloud-API Secret (Confluent)</label>
                  <input id="confluent_sasl_password" name="confluent_sasl_password" type="password" class="ts-input" placeholder="••••••••" required />
                </div>
              </div>
              <div class="flex flex-wrap items-center gap-3 pt-1">
                <button type="button" id="btnTestCflt" class="btn-secondary">Cloud-Verbindung testen</button>
                <span id="cfltBadge" class="badge">…</span>
              </div>
              <div class="flex flex-wrap gap-3 pt-2">
                <button type="submit" class="primary-button">Cloud-Zugang speichern</button>
              </div>
            </form>

            <form method="post" action="/save" class="rounded-[28px] border border-indigo-200/70 bg-white/80 p-7 shadow-2xl shadow-indigo-500/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-indigo-300/20 dark:bg-ink-800/70 dark:shadow-indigo-500/20 space-y-6">
              <input type="hidden" name="section" value="license" />
              <div class="space-y-3">
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Lizenzverwaltung</h2>
                <p class="text-sm text-zinc-600 dark:text-zinc-300">
                  Prüfe deinen Lemon Squeezy Lizenzschlüssel. Der aktive Plan bestimmt automatisch die Aufbewahrungszeit des Offline-Puffers.
                </p>
              </div>
              <div class="grid gap-6 md:grid-cols-2">
                <div>
                  <label class="input-label" for="license_key">Lizenzschlüssel</label>
                  <input id="license_key" name="license_key" class="ts-input" value="{{ license.key }}" placeholder="XXXX-XXXX-XXXX" />
                  <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">Leer lassen, um die Lizenz zu entfernen und auf den Basic-Plan zurückzufallen.</p>
                </div>
                <div class="rounded-2xl border border-indigo-200/70 bg-indigo-50/80 p-4 text-sm shadow-inner dark:border-indigo-300/20 dark:bg-indigo-500/10 dark:text-indigo-100">
                  <p class="text-xs font-semibold uppercase tracking-wide text-indigo-700 dark:text-indigo-200">Aktiver Plan</p>
                  <p class="mt-1 text-lg font-semibold text-indigo-900 dark:text-white">{{ license.plan_label }}</p>
                  <p class="mt-1 text-xs text-indigo-700/80 dark:text-indigo-200/80">Aufbewahrung: {{ data.retention_days }} Tage</p>
                </div>
              </div>
              <input type="hidden" name="license_action" id="license_action" value="validate" />
              <div class="grid gap-4 md:grid-cols-4">
                <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                  <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Status</p>
                  {% set license_days = license.days_remaining %}
                  {% if license_days is not none %}
                  {% set status_color = 'text-emerald-600 dark:text-emerald-300' %}
                  {% if license_days < 0 %}
                    {% set status_color = 'text-rose-600 dark:text-rose-300' %}
                  {% elif license_days <= 14 %}
                    {% set status_color = 'text-amber-600 dark:text-amber-300' %}
                  {% endif %}
                  {% endif %}
                  <p class="mt-1 text-sm font-semibold {{ status_color if license_days is not none else 'text-zinc-800 dark:text-white' }}">
                    {{ license.status_label }}
                  </p>
                  {% if license_days is not none %}
                    {% if license_days >= 0 %}
                    <p class="mt-1 text-[0.75rem] {{ status_color }}">{{ license_days }} Tage verbleiben</p>
                    {% else %}
                    <p class="mt-1 text-[0.75rem] {{ status_color }}">Abgelaufen seit {{ license_days | abs }} Tagen</p>
                    {% endif %}
                  {% endif %}
                </div>
                <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                  <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Gültig bis</p>
                  <p class="mt-1 text-sm font-medium text-zinc-800 dark:text-white" {% if license.valid_until %}title="{{ license.valid_until }}"{% endif %}>
                    {{ license.valid_until_display or '–' }}
                  </p>
                </div>
                <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                  <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Letzte Prüfung</p>
                  <p class="mt-1 text-sm font-medium text-zinc-800 dark:text-white" {% if license.last_checked %}title="{{ license.last_checked }}"{% endif %}>
                    <span id="licenseLastCheckedDate" data-iso="{{ license.last_checked or '' }}">{{ license.last_checked_date_display or '–' }}</span>
                  </p>
                  <p class="text-xs text-zinc-500 dark:text-zinc-400">
                    <span id="licenseLastCheckedTime">{{ license.last_checked_time_display or '' }}</span>
                  </p>
                </div>
                {% set shooter_stats = license.shooter_stats or {} %}
                <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                  <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Vereins-Schützen</p>
                  {% set shooter_error = shooter_stats.error %}
                  {% set shooter_count = shooter_stats.count %}
                  {% if shooter_error and shooter_count is none %}
                  <p class="mt-1 text-sm font-medium text-rose-600 dark:text-rose-300">{{ shooter_error }}</p>
                  {% else %}
                  <p class="mt-1 text-4xl font-semibold text-zinc-900 dark:text-white leading-none">{{ shooter_count if shooter_count is not none else '–' }}</p>
                  {% if shooter_stats.source == 'cache' %}
                  <p class="mt-2 text-[0.65rem] text-amber-600 dark:text-amber-300">Hinweis: Anzeige aus Cache (Offline-Puffer nicht erreichbar).</p>
                  {% elif shooter_error %}
                  <p class="mt-2 text-[0.65rem] text-amber-600 dark:text-amber-300">{{ shooter_error }}</p>
                  {% endif %}
                  {% endif %}
                </div>
              </div>
              <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                <div class="grid gap-2 sm:grid-cols-2">
                  <div>
                    <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">VereinsID</p>
                    <p class="mt-1 text-sm font-medium text-zinc-800 dark:text-white">{{ shooter_stats.verein_id or '–' }}</p>
                  </div>
                  <div>
                    <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Planlimit</p>
                    <p class="mt-1 text-sm font-medium text-zinc-800 dark:text-white">{{ license.shooter_limit_label }}</p>
                  </div>
                  <div>
                    <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Stand</p>
                    <p class="mt-1 text-sm text-zinc-800 dark:text-white">
                      {% if shooter_stats.checked_at %}
                      <span id="shooterStatsChecked" data-iso="{{ shooter_stats.checked_at }}">{{ shooter_stats.checked_at }}</span>
                      {% else %}
                      –
                      {% endif %}
                    </p>
                  </div>
                  <div>
                    <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Planabdeckung</p>
                    {% if shooter_stats.count is not none %}
                      {% if license.shooter_plan_ok %}
                      <p class="mt-1 text-sm font-semibold text-emerald-600 dark:text-emerald-300">Plan {{ license.plan_label }} deckt {{ shooter_stats.count }} Schützen ab.</p>
                      {% else %}
                      <p class="mt-1 text-sm font-semibold text-rose-600 dark:text-rose-300">Plan {{ license.plan_label }} reicht nicht. Benötigt mindestens: {{ license.shooter_required_plan_label }}.</p>
                      {% endif %}
                    {% else %}
                      <p class="mt-1 text-sm text-zinc-800 dark:text-white">Keine Daten</p>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3 pt-2">
                <button type="submit" class="primary-button license-action" data-license-action="validate">Lizenz prüfen</button>
                {% if license_activation_enabled %}
                <button type="submit" id="btnActivateLicense" class="btn-secondary license-action {% if license.activation_id %}opacity-60 cursor-not-allowed{% endif %}" data-license-action="activate" {% if license.activation_id %}disabled aria-disabled="true"{% endif %}>Lizenz aktivieren</button>
                {% endif %}
              </div>
              {% if license.activation_id %}
              <p class="text-xs text-emerald-600 dark:text-emerald-300">Aktiviert am {{ license.activation_at_display or 'unbekannt' }} (ID: {{ license.activation_id }}).</p>
              {% elif license_activation_enabled %}
              <p class="text-xs text-zinc-500 dark:text-zinc-400">Hinweis: Der Aktivieren-Button vergibt einen Installationsslot bei Lemon Squeezy. Verwende ihn nur auf produktiven Systemen.</p>
              {% else %}
              <p class="text-xs leading-relaxed text-zinc-500 dark:text-zinc-400">
                Hinweis: Nur ein gültiger Lizenzschlüssel aktiviert Features über den Basic-Plan hinaus. Bei abgelaufener Lizenz fällt die Aufbewahrung automatisch auf den Basiswert zurück.
              </p>
              {% endif %}
            </form>

          <section class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
            <div class="space-y-4">
              <div>
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Offline-Puffer &amp; Backup</h2>
                <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">
                  Der Offline-Puffer ist dauerhaft aktiv. Alle Sync-Ereignisse werden lokal zwischengespeichert und bei verfügbarer Verbindung automatisch synchronisiert.
                </p>
                <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">
                  Zugangsdaten und Passwort der Backup-Datenbank werden intern zufällig verwaltet und müssen nicht manuell gepflegt werden.
                </p>
              </div>
            </div>
            <div class="rounded-2xl border border-zinc-200/60 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
              <p class="font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400">Plan &amp; Aufbewahrung</p>
              <p class="mt-1 text-sm font-medium text-zinc-800 dark:text-white">Lizenzplan: {{ license.plan_label }}</p>
              <p class="text-xs text-zinc-500 dark:text-zinc-400">Vorhaltezeit aktuell: {{ data.retention_days }} Tage</p>
              {% if not license.key %}
              <p class="mt-2 text-xs text-amber-600 dark:text-amber-300">Keine Lizenz hinterlegt – es gilt automatisch der Basisplan.</p>
              {% endif %}
            </div>
            <div class="flex flex-wrap items-center gap-3 pt-1">
              <button type="button" id="btnTestBackup" class="btn-secondary">Verbindung testen</button>
              <button type="button" id="btnExportBackup" class="btn-secondary">Backup exportieren</button>
              <span id="backupBadge" class="badge">…</span>
            </div>
            <p class="text-xs leading-relaxed text-zinc-500 dark:text-zinc-400">
              Die Lizenzstufe legt die Vorhaltezeit fest (Basic 14 Tage, Plus 30 Tage, Pro 90 Tage). Der Export liefert eine <code>.ndjson</code>-Datei mit allen Einträgen der Tabelle <code>buffer_events</code>.
            </p>
          </section>

        </div>

        <section class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
            <div>
              <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Connector-Steuerung</h2>
                <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Starte, pausiere oder prüfe den Daten-Sync Worker direkt aus der UI.</p>
              </div>
              <div class="flex flex-wrap gap-3">
                <button type="button" id="btnPause" class="btn-secondary">Pause</button>
                <button type="button" id="btnResume" class="btn-secondary">Resume</button>
                <button type="button" id="btnRestart" class="btn-secondary">Restart</button>
                <button type="button" id="btnShowConfig" class="btn-secondary">Konfiguration anzeigen</button>
                <button type="button" id="btnViewSecrets" class="btn-secondary">Secrets anzeigen</button>
                <button type="button" id="btnResnapshot" class="btn-secondary">Reset &amp; Re-Snapshot</button>
              </div>
              <div id="connectorConfigPanel" class="hidden rounded-2xl border border-zinc-200/60 bg-white/80 px-4 py-4 text-xs text-zinc-700 shadow-inner shadow-zinc-900/5 dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                <div id="connectorConfigInfo" class="mb-3 text-[0.72rem] uppercase tracking-wide text-zinc-500 dark:text-zinc-400"></div>
                <pre id="connectorConfigContent" class="max-h-72 overflow-auto whitespace-pre-wrap rounded-xl bg-black/80 p-4 font-mono text-[0.78rem] text-emerald-300 dark:bg-black/60"></pre>
              </div>
              <div id="secretsPanel" class="hidden rounded-2xl border border-zinc-200/60 bg-white/80 px-4 py-4 text-xs text-zinc-700 shadow-inner shadow-zinc-900/5 dark:border-white/10 dark:bg-ink-900/70 dark:text-zinc-200">
                <div id="secretsInfo" class="mb-3 text-[0.72rem] uppercase tracking-wide text-zinc-500 dark:text-zinc-400"></div>
                <pre id="secretsContent" class="max-h-60 overflow-auto whitespace-pre-wrap rounded-xl bg-black/80 p-4 font-mono text-[0.78rem] text-sky-300 dark:bg-black/60"></pre>
              </div>
              <div class="space-y-2 text-xs leading-relaxed text-zinc-500 dark:text-zinc-400">
                <p>Geheimnisse werden sicher in <code>/app/data/secrets.properties</code> mit Dateirecht 0600 gespeichert und bleiben nur im Vereinsnetz zugänglich.</p>
                <div class="flex items-center gap-2">
                  <span class="inline-flex h-2.5 w-2.5 rounded-full {{ 'bg-emerald-400' if has_secrets else 'bg-amber-400' }}"></span>
                  <span>{{ 'secrets.properties vorhanden' if has_secrets else 'secrets.properties wird nach dem ersten Speichern erstellt' }}</span>
                </div>
                <p class="rounded-2xl border border-amber-200/70 bg-amber-100/70 px-3 py-2 text-amber-800 shadow-inner dark:border-amber-300/40 dark:bg-amber-500/10 dark:text-amber-200">
                  <strong>Reset &amp; Re-Snapshot:</strong> Löscht den bestehenden Connector und erstellt ihn neu. Dadurch startet der Daten-Sync eine Vollaufnahme der Vereinsdatenbank.
                  Benutzer sollten dies nur durchführen, wenn Postgres leer ist oder eine komplette Aktualisierung benötigt wird.
                </p>
              </div>
            </section>

            <div class="grid gap-7 lg:grid-cols-2">
              <form method="post" action="/save" class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
                <input type="hidden" name="section" value="admin" />
                <div>
                  <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Administrator-Zugang</h2>
                  <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Aktualisiere bei Bedarf das Admin-Passwort. Das aktuelle Passwort wird zum Speichern jeder Änderung benötigt.</p>
                </div>
                <div>
                  <label class="input-label" for="pw_admin">Aktuelles Admin-Passwort</label>
                  <input id="pw_admin" type="password" name="pw" class="ts-input" placeholder="Admin Passwort" required />
                  <p class="mt-2 text-xs text-zinc-500 dark:text-zinc-400">Pflichtfeld – schützt Konfiguration &amp; Worker-Steuerung.</p>
                </div>
                <div class="grid gap-6 md:grid-cols-2">
                  <div>
                    <label class="input-label" for="new_admin_password">Neues Admin-Passwort</label>
                    <input id="new_admin_password" name="new_admin_password" type="password" class="ts-input" placeholder="Mindestens 8 Zeichen" autocomplete="new-password" required />
                  </div>
                  <div>
                    <label class="input-label" for="confirm_admin_password">Bestätigung</label>
                    <input id="confirm_admin_password" name="confirm_admin_password" type="password" class="ts-input" placeholder="Nochmals eingeben" autocomplete="new-password" required />
                  </div>
                </div>
                <div class="flex flex-wrap gap-3 pt-2">
                  <button type="submit" class="primary-button">Passwort speichern</button>
                </div>
              </form>

            <section class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6">
              <div>
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Connector-Update</h2>
                <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Prüft neue Git-Releases und aktualisiert das Docker-Compose Deployment inklusive Neuaufbau der Services.</p>
              </div>
              <div class="space-y-2 text-xs leading-relaxed text-zinc-500 dark:text-zinc-400">
                <div class="flex flex-wrap items-center gap-3 text-sm">
                  <span id="updateStatusBadge" class="badge">…</span>
                  <span id="updateStatusText" class="text-zinc-700 dark:text-zinc-200">Status wird ermittelt…</span>
                </div>
                <div id="updateVersionInfo">Version wird geladen…</div>
                <div id="updatePrereqHint"></div>
                <div class="mt-3 grid gap-3 rounded-2xl border border-zinc-200/70 bg-white/70 p-4 text-xs shadow-inner dark:border-white/10 dark:bg-white/5">
                  <div class="flex flex-wrap items-center gap-3">
                    <label class="input-label !text-xs" for="autoUpdateHour">Auto-Update täglich um</label>
                    <select id="autoUpdateHour" class="ts-input !max-w-[110px] !py-1.5 !text-xs">
                      {% for h in range(0,24) %}
                      <option value="{{ '%02d' % h }}">{{ '%02d:00' % h }}</option>
                      {% endfor %}
                    </select>
                    <label class="flex items-center gap-2 text-xs font-semibold text-zinc-600 dark:text-zinc-300">
                      <input id="autoUpdateToggle" type="checkbox" class="h-4 w-4 rounded border-zinc-300 text-accent focus:ring-accent" />
                      <span>Automatisch aktiv</span>
                    </label>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-xs text-zinc-600 dark:text-zinc-300">
                    <span class="font-semibold">Nächster Lauf:</span>
                    <span id="autoUpdateNext">–</span>
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-xs text-zinc-500 dark:text-zinc-400">
                    <span class="font-medium">Letzter Auto-Lauf:</span>
                    <span id="autoUpdateLast">–</span>
                  </div>
                  <div class="flex flex-wrap gap-3 pt-1">
                    <button type="button" id="btnSaveAuto" class="btn-secondary">Auto-Update speichern</button>
                  </div>
                </div>
              </div>
              <div class="flex flex-wrap gap-3">
                <button type="button" id="btnCheckUpdate" class="btn-secondary">Nach Update suchen</button>
                <button type="button" id="btnRunUpdate" class="btn-secondary">Update starten</button>
                <span id="updateStatusHint" class="text-xs text-zinc-500 dark:text-zinc-400"></span>
              </div>
            </section>
            <section class="rounded-[28px] border border-zinc-200/70 bg-white/80 p-7 shadow-2xl shadow-zinc-900/10 backdrop-blur supports-[backdrop-filter]:bg-white/60 dark:border-white/10 dark:bg-ink-800/70 dark:shadow-black/30 space-y-6 lg:col-span-2">
              <div>
                <h2 class="brand-sub text-xl font-semibold text-zinc-800 dark:text-zinc-100">Betriebssystem-Updates</h2>
                <p class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Prüft und installiert verfügbare Ubuntu LTS Pakete direkt innerhalb des TargetShot Connect Hosts.</p>
              </div>
              <div class="rounded-2xl border border-zinc-200/70 bg-white/70 p-5 text-sm shadow-inner dark:border-white/10 dark:bg-white/5">
                <div class="flex flex-wrap items-center gap-3">
                  <span id="osUpdateBadge" class="badge">…</span>
                  <div>
                    <p class="font-semibold text-zinc-800 dark:text-white">Paketstatus</p>
                    <p id="osUpdateSummary" class="text-xs text-zinc-500 dark:text-zinc-400">Status wird geladen…</p>
                  </div>
                </div>
                <div class="mt-4 grid gap-3 text-xs text-zinc-600 dark:text-zinc-300 md:grid-cols-2">
                  <div>
                    <p class="font-semibold text-zinc-700 dark:text-zinc-200">Letzte Prüfung</p>
                    <p id="osUpdateLastChecked">–</p>
                  </div>
                  <div>
                    <p class="font-semibold text-zinc-700 dark:text-zinc-200">Letzte Installation</p>
                    <p id="osUpdateLastApplied">–</p>
                  </div>
                </div>
                <div id="osUpdateSecurityNotice" class="mt-3 hidden rounded-2xl border border-amber-200/70 bg-amber-50/80 px-3 py-2 text-xs font-medium text-amber-700 shadow-sm dark:border-amber-300/40 dark:bg-amber-900/30 dark:text-amber-100"></div>
                <ul id="osUpdateList" class="mt-3 space-y-1 text-xs text-zinc-600 dark:text-zinc-300">
                  <li class="text-zinc-500 dark:text-zinc-400">Pakete werden geladen…</li>
                </ul>
                <pre id="osUpdateLog" class="mt-3 hidden max-h-44 overflow-auto whitespace-pre-wrap rounded-2xl bg-black/85 p-3 text-[0.72rem] text-emerald-200 dark:bg-black/60"></pre>
                <div class="mt-4 flex flex-wrap gap-3">
                  <button type="button" id="btnCheckOsUpdates" class="btn-secondary">Systemcheck</button>
                  <button type="button" id="btnApplyOsUpdates" class="btn-secondary">Pakete aktualisieren</button>
                </div>
              </div>
            </section>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <div id="confirmModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div id="confirmModalCard" class="w-full max-w-md rounded-3xl border border-white/10 bg-white/95 p-6 shadow-2xl dark:bg-ink-900/95 dark:text-white">
        <div class="space-y-2">
          <h3 class="brand-sub text-lg font-semibold text-zinc-900 dark:text-white">Bestätigung</h3>
          <p id="confirmModalMessage" class="text-sm text-zinc-600 dark:text-zinc-300"></p>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button type="button" id="confirmModalCancel" class="btn-secondary !bg-white/70 !text-zinc-700 hover:!bg-white dark:!bg-white/20 dark:!text-white">Abbrechen</button>
          <button type="button" id="confirmModalAccept" class="primary-button">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div id="infoModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div id="infoModalCard" class="w-full max-w-md rounded-3xl border border-white/10 bg-white/95 p-6 shadow-2xl dark:bg-ink-900/95 dark:text-white">
        <div class="space-y-2">
          <h3 id="infoModalTitle" class="brand-sub text-lg font-semibold text-zinc-900 dark:text-white">Hinweis</h3>
          <p id="infoModalMessage" class="text-sm text-zinc-600 dark:text-zinc-300"></p>
          <div id="infoModalSpinner" class="hidden mt-4 flex items-center gap-2 text-xs text-zinc-600 dark:text-zinc-300">
            <span class="inline-block h-3 w-3 animate-spin rounded-full border-2 border-zinc-300 border-t-transparent dark:border-zinc-500"></span>
            <span>Bitte warten…</span>
          </div>
        </div>
        <div id="infoModalActions" class="mt-6 flex justify-end">
          <button type="button" id="infoModalClose" class="btn-secondary !bg-white/70 !text-zinc-700 hover:!bg-white dark:!bg-white/20 dark:!text-white">Schließen</button>
        </div>
      </div>
    </div>
  </div>

  <div id="updateModal" class="fixed inset-0 z-50 hidden bg-black/70 backdrop-blur-sm">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-[32px] border border-white/10 bg-white/95 p-6 shadow-2xl shadow-cyan-500/10 dark:bg-ink-900/95 dark:text-white">
        <div class="flex items-center gap-3">
          <span class="inline-flex h-3 w-3 animate-pulse rounded-full bg-emerald-400 shadow-[0_0_12px_rgba(16,185,129,0.6)]"></span>
          <h3 class="brand-sub text-lg font-semibold text-zinc-900 dark:text-white">Update wird ausgeführt</h3>
        </div>
        <p id="updateModalStatus" class="mt-2 text-sm text-zinc-600 dark:text-zinc-300">Docker Compose aktualisiert das System. Bitte diese Ansicht geöffnet lassen.</p>
        <p class="text-xs text-zinc-500 dark:text-zinc-400">Dieses Fenster schließt sich automatisch, sobald das Update abgeschlossen ist.</p>
        <div class="mt-4 h-2 overflow-hidden rounded-full bg-zinc-200/80 dark:bg-white/10">
          <div class="update-progress-strip"></div>
        </div>
        <pre id="updateModalLog" role="log" aria-live="polite" class="mt-4 max-h-80 overflow-auto whitespace-pre-wrap rounded-2xl bg-black/85 p-4 font-mono text-[0.78rem] text-indigo-200 dark:bg-black/60">Noch keine Update-Logs.</pre>
      </div>
    </div>
  </div>

  <div id="passwordModal" class="fixed inset-0 z-50 hidden bg-black/50 backdrop-blur-sm">
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div id="passwordModalCard" class="w-full max-w-md rounded-3xl border border-white/10 bg-white/95 p-6 shadow-2xl dark:bg-ink-900/95 dark:text-white">
        <form id="passwordModalForm" class="space-y-4">
          <div>
            <h3 class="brand-sub text-lg font-semibold text-zinc-900 dark:text-white">Admin-Passwort erforderlich</h3>
            <p class="mt-1 text-sm text-zinc-600 dark:text-zinc-300">Bitte gib das aktuelle Admin-Passwort ein, um mit der Aktion fortzufahren.</p>
        </div>
        <div>
          <label class="input-label" for="passwordModalInput">Admin-Passwort</label>
          <input id="passwordModalInput" name="password" type="password" class="ts-input" placeholder="••••••••" autocomplete="current-password" required />
        </div>
        <div class="flex justify-end gap-3 pt-2">
          <button type="button" id="passwordModalCancel" class="btn-secondary !bg-white/50 !text-zinc-700 hover:!bg-white dark:!bg-white/20 dark:!text-white">Abbrechen</button>
          <button type="submit" class="primary-button">Bestätigen</button>
        </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const passwordModal = document.getElementById('passwordModal');
    const passwordModalForm = document.getElementById('passwordModalForm');
    const passwordModalInput = document.getElementById('passwordModalInput');
    const passwordModalCancel = document.getElementById('passwordModalCancel');
    const infoModal = document.getElementById('infoModal');
    const infoModalCard = document.getElementById('infoModalCard');
    const infoModalTitle = document.getElementById('infoModalTitle');
    const infoModalMessage = document.getElementById('infoModalMessage');
    const infoModalClose = document.getElementById('infoModalClose');
    const infoModalActions = document.getElementById('infoModalActions');
    const infoModalSpinner = document.getElementById('infoModalSpinner');
    const confirmModal = document.getElementById('confirmModal');
    const confirmModalCard = document.getElementById('confirmModalCard');
    const confirmModalMessage = document.getElementById('confirmModalMessage');
    const confirmModalAccept = document.getElementById('confirmModalAccept');
    const confirmModalCancel = document.getElementById('confirmModalCancel');
    const INFO_MODAL_BASE = 'w-full max-w-md rounded-3xl border border-white/10 bg-white/95 p-6 shadow-2xl dark:bg-ink-900/95 dark:text-white';
    const INFO_MODAL_ERROR = 'border-rose-300 bg-rose-100 dark:border-rose-400/40 dark:bg-rose-900/40 dark:text-rose-100';
    const INFO_MODAL_TITLE_BASE = 'brand-sub text-lg font-semibold text-zinc-900 dark:text-white';
    const INFO_MODAL_TITLE_ERROR = 'brand-sub text-lg font-semibold text-rose-700 dark:text-rose-200';
    const INFO_MODAL_MESSAGE_BASE = 'text-sm text-zinc-600 dark:text-zinc-300';
    const INFO_MODAL_MESSAGE_ERROR = 'text-sm text-rose-600 dark:text-rose-200';
    let passwordResolver = null;
    let confirmResolver = null;

    function closePasswordModal() {
      passwordModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      passwordModalInput.value = '';
    }

    function resolvePasswordModal(value) {
      if (!passwordResolver) return;
      const resolver = passwordResolver;
      passwordResolver = null;
      closePasswordModal();
      resolver(value);
    }

    function askAdminPassword() {
      if (passwordResolver) {
        return Promise.resolve(null);
      }
      passwordModal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      setTimeout(() => passwordModalInput.focus(), 50);
      return new Promise((resolve) => {
        passwordResolver = resolve;
      });
    }

    passwordModalForm.addEventListener('submit', (event) => {
      event.preventDefault();
      if (!passwordModalInput.value) {
        passwordModalInput.focus();
        return;
      }
      resolvePasswordModal(passwordModalInput.value);
    });

    passwordModalCancel.addEventListener('click', () => {
      resolvePasswordModal(null);
    });

    passwordModal.addEventListener('click', (event) => {
      if (event.target === passwordModal) {
        resolvePasswordModal(null);
      }
    });

    function closeConfirmModal() {
      confirmModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    function resolveConfirmModal(value) {
      if (!confirmResolver) return;
      const resolver = confirmResolver;
      confirmResolver = null;
      closeConfirmModal();
      resolver(!!value);
    }

    function showConfirmModal(message) {
      confirmModalMessage.textContent = message;
      confirmModalCard.className = INFO_MODAL_BASE;
      confirmModal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      return new Promise((resolve) => {
        confirmResolver = resolve;
        confirmModalAccept.focus();
      });
    }

    confirmModalAccept.addEventListener('click', () => resolveConfirmModal(true));
    confirmModalCancel.addEventListener('click', () => resolveConfirmModal(false));
    confirmModal.addEventListener('click', (event) => {
      if (event.target === confirmModal) {
        resolveConfirmModal(false);
      }
    });

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && passwordResolver) {
        resolvePasswordModal(null);
      }
      if (event.key === 'Escape' && confirmResolver) {
        resolveConfirmModal(false);
      }
      if (event.key === 'Escape' && !infoModal.classList.contains('hidden')) {
        closeInfoModal(true);
      }
    });

    function closeInfoModal() {
      if (infoModal.classList.contains('hidden')) return;
      infoModal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
      infoModalTitle.textContent = '';
      infoModalMessage.textContent = '';
    }

    function showInfoModal(title, message, variant = 'info') {
      infoModalTitle.textContent = title;
      infoModalMessage.textContent = message;
      const isError = variant === 'error';
      infoModalCard.className = isError ? `${INFO_MODAL_BASE} ${INFO_MODAL_ERROR}` : INFO_MODAL_BASE;
      infoModalTitle.className = isError ? INFO_MODAL_TITLE_ERROR : INFO_MODAL_TITLE_BASE;
      infoModalMessage.className = isError ? INFO_MODAL_MESSAGE_ERROR : INFO_MODAL_MESSAGE_BASE;
      infoModal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
      infoModalClose.focus();
    }

    infoModalClose.addEventListener('click', () => closeInfoModal());
    infoModal.addEventListener('click', (event) => {
      if (event.target === infoModal) {
        closeInfoModal();
      }
    });

    function setBadge(el, state, msg) {
      let label;
      if (state === 'pending') {
        el.className = 'badge warn';
        label = 'Wartet';
      } else if (state === 'warn') {
        el.className = 'badge warn';
        label = 'Warnung';
      } else {
        const ok = !!state;
        el.className = 'badge ' + (ok ? 'ok' : 'warn');
        label = ok ? 'OK' : 'Fehler';
      }
      el.textContent = label + (msg ? (' – ' + msg) : '');
    }
    document.getElementById('btnWorker').onclick = async () => {
      const r = await fetch('/api/status');
      const j = await r.json();
      loadHealthSummary(false).catch(() => {});
      const badge = document.getElementById('statusBadge');
      if (j.worker === 'pending') {
        const baseMsg = j.error || j.applyState?.last_error || 'Connector wartet auf Datenbank';
        const retryInfo = j.applyState?.next_retry ? (' Nächster Versuch: ' + j.applyState.next_retry) : '';
        setBadge(badge, 'pending', baseMsg + retryInfo);
      } else {
        const ok = j.worker === 'ok';
        setBadge(badge, ok, ok ? '' : (j.error || 'Worker down'));
      }
    };
    document.getElementById('btnTestDb').onclick = async () => {
      const qs = new URLSearchParams({
        host: document.getElementById('db_host').value,
        port: document.getElementById('db_port').value,
        user: document.getElementById('db_user').value,
        password: document.getElementById('db_password').value
      });
      const r = await fetch('/api/test/db?' + qs.toString());
      const j = await r.json();
      setBadge(document.getElementById('dbBadge'), j.ok, j.msg);
    };
    document.getElementById('btnTestCflt').onclick = async () => {
      const qs = new URLSearchParams({
        bootstrap: document.getElementById('confluent_bootstrap').value
      });
      const r = await fetch('/api/test/confluent?' + qs.toString());
      const j = await r.json();
      setBadge(document.getElementById('cfltBadge'), j.ok, j.msg);
    };
    const backupBadgeEl = document.getElementById('backupBadge');
    const btnTestBackup = document.getElementById('btnTestBackup');
    if (btnTestBackup && backupBadgeEl) {
      btnTestBackup.onclick = async () => {
        setBadge(backupBadgeEl, 'pending', 'Prüfe Verbindung…');
        try {
          const r = await fetch('/api/test/backup-db');
          const j = await r.json();
          setBadge(backupBadgeEl, j.ok, j.msg);
        } catch (err) {
          setBadge(backupBadgeEl, false, err?.message || 'Serverfehler');
        }
      };
    }
    const btnExportBackup = document.getElementById('btnExportBackup');
    if (btnExportBackup && backupBadgeEl) {
      btnExportBackup.onclick = async () => {
        setBadge(backupBadgeEl, 'pending', 'Export läuft…');
        try {
          const r = await fetch('/api/backup/export');
          if (!r.ok) {
            let msg = 'Export fehlgeschlagen';
            try {
              const err = await r.json();
              msg = err?.detail || msg;
            } catch (_) {
              const text = await r.text();
              if (text) msg = text;
            }
            setBadge(backupBadgeEl, false, msg);
            return;
          }
          const blob = await r.blob();
          let filename = 'backup.ndjson';
          const disposition = r.headers.get('Content-Disposition');
          if (disposition) {
            const match = disposition.match(/filename="?([^";]+)"?/i);
            if (match && match[1]) {
              filename = match[1];
            }
          }
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          link.remove();
          URL.revokeObjectURL(url);
          setBadge(backupBadgeEl, true, 'Export heruntergeladen');
        } catch (err) {
          setBadge(backupBadgeEl, false, err?.message || 'Export fehlgeschlagen');
        }
      };
    }
    const licenseActionInput = document.getElementById('license_action');
    if (licenseActionInput) {
      document.querySelectorAll('.license-action').forEach((btn) => {
        btn.addEventListener('click', () => {
          if (btn.hasAttribute('disabled') || btn.classList.contains('cursor-not-allowed')) return;
          licenseActionInput.value = btn.dataset.licenseAction || 'validate';
        });
      });
    }
    async function connectorAction(action) {
      const pw = await askAdminPassword();
      if (!pw) return;
      const fd = new FormData();
      fd.append('pw', pw);
      const r = await fetch('/api/connector/control/' + action, { method: 'POST', body: fd });
      const j = await r.json();
      alert(action + ': ' + (j.ok ? 'OK' : ('Fehler (' + j.status + ')')));
    }
    document.getElementById('btnPause').onclick = () => connectorAction('pause');
    document.getElementById('btnResume').onclick = () => connectorAction('resume');
    document.getElementById('btnRestart').onclick = () => connectorAction('restart');
    document.getElementById('btnResnapshot').onclick = async () => {
      const confirmed = await showConfirmModal('Connector zurücksetzen und komplette Datenaufnahme neu starten? Dieser Vorgang löscht den aktuellen Sync-Status.');
      if (!confirmed) return;
      const pw = await askAdminPassword();
      if (!pw) return;
      const fd = new FormData();
      fd.append('pw', pw);
      const r = await fetch('/api/connector/resnapshot', { method: 'POST', body: fd });
      const j = await r.json().catch(() => ({}));
      if (r.ok && j.ok) {
        if (j.pending) {
          alert(j.message || 'Connector-Neuanlage wartet auf die Vereinsdatenbank und wird automatisch fortgesetzt.');
        } else {
          alert('Connector wurde neu erstellt. Der Daten-Sync startet jetzt eine Vollaufnahme.');
        }
      } else {
        alert('Fehler beim Reset: ' + (j.detail || j.error || r.status));
      }
    };
    const configPanel = document.getElementById('connectorConfigPanel');
    const configContent = document.getElementById('connectorConfigContent');
    const configInfo = document.getElementById('connectorConfigInfo');
    const secretsPanel = document.getElementById('secretsPanel');
    const secretsContent = document.getElementById('secretsContent');
    const secretsInfo = document.getElementById('secretsInfo');
    document.getElementById('btnShowConfig').onclick = async () => {
      if (!configPanel.classList.contains('hidden')) {
        configPanel.classList.add('hidden');
        return;
      }
      configPanel.classList.remove('hidden');
      configInfo.textContent = 'Lade aktuelle Konfiguration…';
      configContent.textContent = '';
      try {
        const response = await fetch('/api/connector/config');
        if (!response.ok) {
          const text = await response.text();
          configInfo.textContent = 'Fehler beim Abrufen der Konfiguration';
          configContent.textContent = text;
          return;
        }
        const json = await response.json();
        if (json.exists === false) {
          configInfo.textContent = 'Connector ist noch nicht angelegt.';
          configContent.textContent = '';
          return;
        }
        configInfo.textContent = 'Aktuelle Connector-Konfiguration';
        configContent.textContent = JSON.stringify(json.config, null, 2);
      } catch (error) {
        configInfo.textContent = 'Fehler beim Abrufen der Konfiguration';
        configContent.textContent = error instanceof Error ? error.message : String(error);
      }
    };
    document.getElementById('btnViewSecrets').onclick = async () => {
      if (!secretsPanel.classList.contains('hidden')) {
        secretsPanel.classList.add('hidden');
        return;
      }
      const pw = await askAdminPassword();
      if (!pw) return;
      const fd = new FormData();
      fd.append('pw', pw);
      secretsPanel.classList.remove('hidden');
      secretsInfo.textContent = 'Lade secrets.properties…';
      secretsContent.textContent = '';
      try {
        const response = await fetch('/api/secrets/view', { method: 'POST', body: fd });
        const json = await response.json().catch(() => ({}));
        if (!response.ok || !json.ok) {
          const detail = json.detail || json.error || response.statusText || response.status;
          secretsInfo.textContent = 'Fehler beim Laden von secrets.properties';
          secretsContent.textContent = detail ? String(detail) : 'Unbekannter Fehler';
          return;
        }
        secretsInfo.textContent = json.modified ? ('secrets.properties – zuletzt geändert: ' + json.modified) : 'secrets.properties Inhalt';
        secretsContent.textContent = json.content || '(Datei ist leer)';
      } catch (error) {
        secretsInfo.textContent = 'Fehler beim Laden von secrets.properties';
        secretsContent.textContent = error instanceof Error ? error.message : String(error);
      }
    };

    const updateStatusBadge = document.getElementById('updateStatusBadge');
    const updateStatusText = document.getElementById('updateStatusText');
    const updateVersionInfo = document.getElementById('updateVersionInfo');
    const updatePrereqHint = document.getElementById('updatePrereqHint');
    const updateModal = document.getElementById('updateModal');
    const updateModalStatus = document.getElementById('updateModalStatus');
    const updateModalLog = document.getElementById('updateModalLog');
    const btnCheckUpdate = document.getElementById('btnCheckUpdate');
    const btnRunUpdate = document.getElementById('btnRunUpdate');
    const btnCheckOsUpdates = document.getElementById('btnCheckOsUpdates');
    const btnApplyOsUpdates = document.getElementById('btnApplyOsUpdates');
    const updateStatusHint = document.getElementById('updateStatusHint');
    const licenseLastCheckedDateEl = document.getElementById('licenseLastCheckedDate');
    const licenseLastCheckedTimeEl = document.getElementById('licenseLastCheckedTime');
    const shooterStatsCheckedEl = document.getElementById('shooterStatsChecked');
    const dbStatusBadge = document.getElementById('dbStatusBadge');
    const dbStatusMessage = document.getElementById('dbStatusMessage');
    const confluentStatusBadge = document.getElementById('confluentStatusBadge');
    const confluentStatusMessage = document.getElementById('confluentStatusMessage');
    const connectorStatusBadge = document.getElementById('connectorStatusBadge');
    const connectorStatusMessage = document.getElementById('connectorStatusMessage');
    const backupStatusBadge = document.getElementById('backupStatusBadge');
    const backupStatusMessage = document.getElementById('backupStatusMessage');
    const licenseStatusBadge = document.getElementById('licenseStatusBadge');
    const licenseStatusMessage = document.getElementById('licenseStatusMessage');
    const elasticAgentStatusBadge = document.getElementById('elasticAgentStatusBadge');
    const elasticAgentStatusMessage = document.getElementById('elasticAgentStatusMessage');
    const btnCheckDefaultText = btnCheckUpdate ? btnCheckUpdate.textContent : '';
    const btnCheckOsDefaultText = btnCheckOsUpdates ? btnCheckOsUpdates.textContent : '';
    const btnApplyOsDefaultText = btnApplyOsUpdates ? btnApplyOsUpdates.textContent : '';
    const autoUpdateToggle = document.getElementById('autoUpdateToggle');
    let updateReloadTimer = null;
    const autoUpdateHour = document.getElementById('autoUpdateHour');
    const autoUpdateNext = document.getElementById('autoUpdateNext');
    const autoUpdateLast = document.getElementById('autoUpdateLast');
    const btnSaveAuto = document.getElementById('btnSaveAuto');
    let updatePollTimer = null;
    let updateModalVisible = false;
    const osUpdateBadge = document.getElementById('osUpdateBadge');
    const osUpdateSummary = document.getElementById('osUpdateSummary');
    const osUpdateList = document.getElementById('osUpdateList');
    const osUpdateLastChecked = document.getElementById('osUpdateLastChecked');
    const osUpdateLastApplied = document.getElementById('osUpdateLastApplied');
    const osUpdateSecurityNotice = document.getElementById('osUpdateSecurityNotice');
    const osUpdateLog = document.getElementById('osUpdateLog');
    let osUpdatePollTimer = null;

    function escapeHtml(value) {
      return value.replace(/[&<>"']/g, function (match) {
        const map = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
        return map[match] || match;
      });
    }

    function formatIso(iso) {
      if (!iso) return '–';
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) return iso;
      return date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function hydrateLicenseTimestamp() {
      if (!licenseLastCheckedDateEl) return;
      const iso = licenseLastCheckedDateEl.dataset.iso;
      if (!iso) {
        licenseLastCheckedDateEl.textContent = '–';
        if (licenseLastCheckedTimeEl) licenseLastCheckedTimeEl.textContent = '';
        return;
      }
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) {
        return;
      }
      licenseLastCheckedDateEl.textContent = date.toLocaleDateString(undefined, { day: '2-digit', month: '2-digit', year: 'numeric' });
      if (licenseLastCheckedTimeEl) {
        licenseLastCheckedTimeEl.textContent = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) + ' Uhr';
      }
    }

    function hydrateShooterTimestamp() {
      if (!shooterStatsCheckedEl) return;
      const iso = shooterStatsCheckedEl.dataset.iso;
      if (!iso) {
        shooterStatsCheckedEl.textContent = '–';
        return;
      }
      const date = new Date(iso);
      if (Number.isNaN(date.getTime())) {
        return;
      }
      shooterStatsCheckedEl.textContent = date.toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' });
    }

    function openUpdateProgressModal(statusText) {
      if (!updateModal) return;
      if (statusText && updateModalStatus) {
        updateModalStatus.textContent = statusText;
      }
      updateModal.classList.remove('hidden');
      updateModalVisible = true;
    }

    function closeUpdateProgressModal() {
      if (!updateModalVisible || !updateModal) return;
      updateModal.classList.add('hidden');
      updateModalVisible = false;
      if (updateModalLog) {
        updateModalLog.textContent = 'Noch keine Update-Logs.';
        updateModalLog.scrollTop = 0;
      }
    }

    function setUpdateModalLogContent(lines) {
      if (!updateModalLog) return;
      if (Array.isArray(lines) && lines.length) {
        updateModalLog.textContent = lines.join('\n');
        updateModalLog.scrollTop = updateModalLog.scrollHeight;
      } else {
        updateModalLog.textContent = 'Noch keine Update-Logs.';
        updateModalLog.scrollTop = 0;
      }
    }

    function syncUpdateModal(state) {
      if (!updateModal) return;
      const running = state && state.status === 'running';
      if (running) {
        if (!updateModalVisible) {
          openUpdateProgressModal(state?.current_action || 'Update wird vorbereitet…');
        } else if (state?.current_action && updateModalStatus) {
          updateModalStatus.textContent = state.current_action;
        }
        setUpdateModalLogContent(state?.log);
      } else if (updateModalVisible) {
        closeUpdateProgressModal();
      }
    }

    function setUpdateBadge(state, currentAction, lastError) {
      if (!updateStatusBadge) return;
      let cls = 'badge ';
      let label = 'Status';
      if (state === 'running') {
        cls += 'warn';
        label = 'Aktiv';
      } else if (state === 'error') {
        cls += 'warn';
        label = 'Fehler';
      } else if (state === 'idle') {
        cls += 'ok';
        label = 'Bereit';
      } else {
        cls += 'warn';
        label = String(state || '?');
      }
      updateStatusBadge.className = cls;
      updateStatusBadge.textContent = label;
      if (updateStatusText) {
        let message = currentAction;
        if (!message) {
          if (state === 'error') {
            message = lastError || 'Update fehlgeschlagen';
          } else if (state === 'running') {
            message = 'Update läuft…';
          } else if (state === 'idle') {
            message = 'Bereit';
          } else {
            message = 'Status unbekannt';
          }
        }
        updateStatusText.textContent = message;
      }
    }

    function renderPrerequisites(prereq) {
      if (!updatePrereqHint) return;
      if (!prereq || prereq.ok) {
        updatePrereqHint.className = 'text-xs text-emerald-600 dark:text-emerald-300';
        updatePrereqHint.textContent = 'Alle Voraussetzungen erfüllt. Auto-Update kann gestartet werden.';
        return;
      }
      const missing = [];
      if (!prereq.git) missing.push('git');
      if (!prereq.docker) missing.push('docker');
      if (!prereq.docker_socket) missing.push('Docker Socket');
      if (!prereq.workspace) missing.push('Workspace-Mount');
      updatePrereqHint.className = 'text-xs text-amber-600 dark:text-amber-300';
      updatePrereqHint.textContent = 'Voraussetzungen fehlen: ' + missing.join(', ');
    }

    function scheduleUpdateReload() {
      if (updateReloadTimer) return;
      const probe = async () => {
        try {
          const response = await fetch('/api/status', { cache: 'no-store' });
          if (response.ok) {
            window.location.reload();
            return;
          }
        } catch (error) {
          // UI likely restarting; keep polling
        }
        updateReloadTimer = setTimeout(probe, 4000);
      };
      updateReloadTimer = setTimeout(probe, 4000);
    }

    function updateStatusDetail(el, status, message) {
      if (!el) return;
      el.textContent = message || '';
      el.classList.remove('is-visible', 'status-ok', 'status-warn', 'status-error');
      if (message) {
        el.classList.add('is-visible');
        if (status === 'ok') {
          el.classList.add('status-ok');
        } else if (status === 'warn' || status === 'pending' || status === 'skipped') {
          el.classList.add('status-warn');
        } else if (status === 'error') {
          el.classList.add('status-error');
        }
      }
    }

    function setHealthBadge(el, summary, detailEl) {
      if (!el) return;
      const status = summary && summary.status ? summary.status : 'unknown';
      const message = summary && summary.message ? summary.message : '';
      updateStatusDetail(detailEl, status, message);
      const detailAwareMessage = detailEl ? '' : (message || '');
      if (status === 'ok') {
        setBadge(el, true, detailAwareMessage);
      } else if (status === 'error') {
        setBadge(el, false, detailAwareMessage || 'Fehler');
      } else if (status === 'warn') {
        setBadge(el, 'warn', detailAwareMessage || 'Warnung');
      } else if (status === 'skipped') {
        setBadge(el, 'pending', detailAwareMessage || 'Deaktiviert');
      } else {
        setBadge(el, 'pending', detailAwareMessage || 'Unbekannt');
      }
      if (detailEl && message) {
        el.setAttribute('title', message);
      } else {
        el.removeAttribute('title');
      }
    }

    async function loadHealthSummary(showError) {
      try {
        const response = await fetch('/api/health/summary');
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const detail = data.detail || response.statusText || response.status;
          throw new Error(String(detail));
        }
        setHealthBadge(dbStatusBadge, data.database, dbStatusMessage);
        setHealthBadge(confluentStatusBadge, data.confluent, confluentStatusMessage);
        setHealthBadge(connectorStatusBadge, data.connector, connectorStatusMessage);
        setHealthBadge(backupStatusBadge, data.backup, backupStatusMessage);
        setHealthBadge(licenseStatusBadge, data.license, licenseStatusMessage);
        setHealthBadge(elasticAgentStatusBadge, data.elastic_agent, elasticAgentStatusMessage);
      } catch (error) {
        if (showError) {
          const message = error instanceof Error ? error.message : String(error);
          showInfoModal('Statusfehler', message, 'error');
        }
        setHealthBadge(dbStatusBadge, { status: 'error', message: '' }, dbStatusMessage);
        setHealthBadge(confluentStatusBadge, { status: 'error', message: '' }, confluentStatusMessage);
        setHealthBadge(connectorStatusBadge, { status: 'error', message: '' }, connectorStatusMessage);
        setHealthBadge(backupStatusBadge, { status: 'error', message: '' }, backupStatusMessage);
        setHealthBadge(licenseStatusBadge, { status: 'error', message: '' }, licenseStatusMessage);
        setHealthBadge(elasticAgentStatusBadge, { status: 'error', message: '' }, elasticAgentStatusMessage);
      }
    }

    function renderOsUpdateState(data) {
      if (!osUpdateBadge) return;
      const packages = Array.isArray(data?.packages) ? data.packages : [];
      const pending = Number(data?.pending_count || 0);
      const security = Number(data?.security_count || 0);
      const checkRunning = !!data?.check_in_progress;
      const updateRunning = !!data?.update_in_progress;
      const summaryParts = [];
      if (updateRunning) {
        summaryParts.push('Installation läuft…');
      } else if (checkRunning) {
        summaryParts.push('Prüfung läuft…');
      } else if (pending > 0) {
        summaryParts.push(`${pending} Update${pending === 1 ? '' : 's'} verfügbar`);
      } else {
        summaryParts.push('Alle Pakete aktuell');
      }
      if (security > 0) {
        summaryParts.push(`${security} Sicherheitsupdate${security === 1 ? '' : 's'}`);
      }
      if (data?.last_check_error) {
        summaryParts.push(`Check-Fehler: ${data.last_check_error}`);
      }
      if (data?.last_update_error) {
        summaryParts.push(`Update-Fehler: ${data.last_update_error}`);
      }
      if (osUpdateSummary) {
        osUpdateSummary.textContent = summaryParts.join(' · ');
      }
      if (updateRunning) {
        setBadge(osUpdateBadge, 'pending', 'Installation läuft…');
      } else if (checkRunning) {
        setBadge(osUpdateBadge, 'pending', 'Prüfung läuft…');
      } else if (pending === 0) {
        setBadge(osUpdateBadge, true, 'Aktuell');
      } else {
        setBadge(osUpdateBadge, 'warn', `${pending} offen`);
      }
      if (osUpdateLastChecked) {
        osUpdateLastChecked.textContent = formatIso(data?.last_check);
      }
      if (osUpdateLastApplied) {
        osUpdateLastApplied.textContent = formatIso(data?.last_update);
      }
      if (osUpdateSecurityNotice) {
        if (security > 0) {
          osUpdateSecurityNotice.classList.remove('hidden');
          osUpdateSecurityNotice.textContent = `${security} Sicherheitsupdate${security === 1 ? '' : 's'} warten auf Installation.`;
        } else {
          osUpdateSecurityNotice.classList.add('hidden');
          osUpdateSecurityNotice.textContent = '';
        }
      }
      if (osUpdateList) {
        const maxEntries = 6;
        if (!packages.length) {
          osUpdateList.innerHTML = '<li class="text-zinc-500 dark:text-zinc-400">Keine Updates offen.</li>';
        } else {
          const rows = packages.slice(0, maxEntries).map((pkg) => {
            const name = escapeHtml(pkg?.name || 'paket');
            const targetVersion = pkg?.version ? escapeHtml(pkg.version) : '';
            const currentVersion = pkg?.current ? escapeHtml(pkg.current) : '';
            const versionInfo = targetVersion
              ? (currentVersion ? `${currentVersion} → ${targetVersion}` : `Version ${targetVersion}`)
              : (currentVersion ? `Installiert: ${currentVersion}` : '');
            const badgeClass = pkg?.security
              ? 'bg-amber-100/80 text-amber-800 dark:bg-amber-900/40 dark:text-amber-100'
              : 'bg-zinc-200/60 text-zinc-700 dark:bg-zinc-800/70 dark:text-zinc-200';
            const badgeLabel = pkg?.security
              ? 'Security'
              : escapeHtml(pkg?.section || 'Stable');
            return `<li class="flex items-center justify-between gap-3 rounded-2xl border border-zinc-200/70 bg-white/80 px-3 py-1.5 text-[0.72rem] shadow-sm dark:border-white/10 dark:bg-white/5">
              <span class="flex flex-col">
                <span class="font-semibold text-zinc-800 dark:text-white">${name}</span>
                <span class="text-[0.65rem] text-zinc-500 dark:text-zinc-300">${versionInfo}</span>
              </span>
              <span class="rounded-full px-2 py-0.5 text-[0.6rem] font-semibold ${badgeClass}">${badgeLabel}</span>
            </li>`;
          });
          const totalPackages = Number(data?.packages_total || packages.length);
          if (totalPackages > maxEntries) {
            rows.push(`<li class="text-[0.7rem] text-zinc-500 dark:text-zinc-400">+${totalPackages - maxEntries} weitere Pakete…</li>`);
          }
          osUpdateList.innerHTML = rows.join('');
        }
      }
      if (osUpdateLog) {
        const logLines = Array.isArray(data?.log) ? data.log : [];
        const hasLog =
          (updateRunning || checkRunning || logLines.length > 0) &&
          logLines.some((line) => typeof line === 'string' && line.trim().length > 0);
        if (hasLog) {
          osUpdateLog.classList.remove('hidden');
          osUpdateLog.textContent = logLines.join('\n') || 'Keine Logausgaben.';
        } else {
          osUpdateLog.classList.add('hidden');
          osUpdateLog.textContent = '';
        }
      }
      if (btnCheckOsUpdates) {
        const disabled = checkRunning || updateRunning;
        btnCheckOsUpdates.disabled = disabled;
        btnCheckOsUpdates.classList.toggle('opacity-60', disabled);
        btnCheckOsUpdates.classList.toggle('cursor-not-allowed', disabled);
        if (!disabled && btnCheckOsDefaultText) {
          btnCheckOsUpdates.textContent = btnCheckOsDefaultText;
        }
      }
      if (btnApplyOsUpdates) {
        const disabled = updateRunning || pending === 0;
        btnApplyOsUpdates.disabled = disabled;
        btnApplyOsUpdates.classList.toggle('opacity-60', disabled);
        btnApplyOsUpdates.classList.toggle('cursor-not-allowed', disabled);
        if (!disabled && btnApplyOsDefaultText) {
          btnApplyOsUpdates.textContent = btnApplyOsDefaultText;
        }
      }
    }

    async function loadOsUpdateStatus(force) {
      if (!osUpdateBadge) return;
      if (osUpdatePollTimer) {
        clearTimeout(osUpdatePollTimer);
        osUpdatePollTimer = null;
      }
      try {
        const url = force ? '/api/os-updates/status?refresh=1' : '/api/os-updates/status';
        const response = await fetch(url);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const detail = data.detail || response.statusText || response.status;
          throw new Error(String(detail));
        }
        renderOsUpdateState(data);
        if (data.update_in_progress || data.check_in_progress) {
          osUpdatePollTimer = setTimeout(() => {
            loadOsUpdateStatus(false).catch(() => {});
          }, 5000);
        }
      } catch (error) {
        if (osUpdateSummary) {
          osUpdateSummary.textContent = error instanceof Error ? error.message : String(error);
        }
        if (osUpdateBadge) {
          setBadge(osUpdateBadge, false, 'Fehler');
        }
        if (btnCheckOsUpdates) {
          btnCheckOsUpdates.disabled = false;
          btnCheckOsUpdates.classList.remove('opacity-60', 'cursor-not-allowed');
          btnCheckOsUpdates.textContent = btnCheckOsDefaultText || 'Systemcheck';
        }
        if (btnApplyOsUpdates) {
          btnApplyOsUpdates.disabled = false;
          btnApplyOsUpdates.classList.remove('opacity-60', 'cursor-not-allowed');
          btnApplyOsUpdates.textContent = btnApplyOsDefaultText || 'Pakete aktualisieren';
        }
        if (!osUpdatePollTimer) {
          osUpdatePollTimer = setTimeout(() => {
            loadOsUpdateStatus(false).catch(() => {});
          }, 15000);
        }
      }
    }

    async function loadUpdateStatus(force) {
      if (!updateStatusBadge) return;
      if (updatePollTimer) {
        clearTimeout(updatePollTimer);
        updatePollTimer = null;
      }
      try {
        const url = force ? '/api/update/status?force=1' : '/api/update/status';
        const response = await fetch(url);
        const data = await response.json().catch(() => ({}));
        if (!response.ok) {
          const detail = data.detail || response.statusText || response.status;
          throw new Error(String(detail));
        }
        setUpdateBadge(data.status, data.current_action, data.last_error);
        if (btnCheckUpdate) {
          btnCheckUpdate.textContent = btnCheckDefaultText || 'Nach Update suchen';
        }
        if (updateVersionInfo) {
          const parts = [];
          if (data.current_version) {
            parts.push('Aktuelle Version: ' + data.current_version);
          }
        if (data.latest_release && data.latest_release.tag_name) {
          const versionName = data.latest_release.name || data.latest_release.tag_name;
          if (data.latest_release.html_url) {
            parts.push('Letzte Version: <a class="text-accent-dark dark:text-accent" target="_blank" rel="noopener" href="' + data.latest_release.html_url + '">' + escapeHtml(versionName) + '</a>');
          } else {
            parts.push('Letzte Version: ' + escapeHtml(versionName));
          }
          }
          if (data.update_available) {
            parts.push('<strong>Update verfügbar</strong>');
          }
          updateVersionInfo.innerHTML = parts.length ? parts.join(' · ') : 'Keine Versionsinformationen verfügbar.';
        }
        renderPrerequisites(data.prerequisites);
        if (btnRunUpdate) {
          const disabled = !data.update_available || !data.prerequisites || !data.prerequisites.ok || data.status === 'running';
          btnRunUpdate.disabled = disabled;
          btnRunUpdate.classList.toggle('opacity-60', disabled);
          btnRunUpdate.classList.toggle('cursor-not-allowed', disabled);
          btnRunUpdate.title = disabled && !data.update_available ? 'Kein neues Release verfügbar' : '';
          btnRunUpdate.textContent = disabled ? 'Auf aktuellem Stand' : 'Update starten';
          if (updateStatusHint) {
            updateStatusHint.textContent = disabled ? 'Kein neues Release verfügbar' : 'Neues Release bereit';
            updateStatusHint.className = disabled ? 'text-xs text-zinc-500 dark:text-zinc-400' : 'text-xs text-emerald-500 dark:text-emerald-300';
          }
          if (btnCheckUpdate && !btnCheckUpdate.disabled) {
            btnCheckUpdate.textContent = btnCheckDefaultText || 'Nach Update suchen';
          }
        }
        if (autoUpdateToggle) {
          const auto = data.auto_update || {};
          autoUpdateToggle.checked = !!auto.enabled;
          autoUpdateToggle.disabled = data.status === 'running';
        }
        if (autoUpdateHour) {
          const auto = data.auto_update || {};
          const hourValue = (auto.hour ?? 1).toString().padStart(2, '0');
          autoUpdateHour.value = hourValue;
          autoUpdateHour.disabled = data.status === 'running';
        }
        if (autoUpdateNext) {
          const auto = data.auto_update || {};
          if (auto.enabled) {
            autoUpdateNext.textContent = auto.next_run_local || (auto.next_run ? formatIso(auto.next_run) : '–');
          } else {
            autoUpdateNext.textContent = '–';
          }
        }
        if (autoUpdateLast) {
          const auto = data.auto_update || {};
          autoUpdateLast.textContent = auto.last_run_local || (auto.last_run ? formatIso(auto.last_run) : '–');
        }
        if (btnSaveAuto) {
          const disabled = data.status === 'running';
          btnSaveAuto.disabled = disabled;
          btnSaveAuto.classList.toggle('opacity-60', disabled);
          btnSaveAuto.classList.toggle('cursor-not-allowed', disabled);
        }
        syncUpdateModal(data);
        loadHealthSummary(false).catch(() => {});
        if (data.status === 'running') {
          updatePollTimer = setTimeout(() => {
            loadUpdateStatus(false).catch(() => {});
          }, 5000);
        }
      } catch (error) {
        const message = error instanceof Error ? error.message : String(error);
        if (updateModalVisible) {
          setUpdateBadge('running', 'Update läuft…', null);
          const lines = [
            'Update läuft weiter – während der Dienste-Neustarts ist die Statusabfrage kurz nicht erreichbar.',
            'Die UI verbindet sich automatisch erneut…'
          ];
          if (message && message !== 'Failed to fetch') {
            lines.push('Hinweis: ' + message);
          }
          setUpdateModalLogContent(lines);
        } else {
          setUpdateBadge('error', 'Status kann nicht abgerufen werden', message);
        }
      }
    }

    if (btnCheckUpdate) {
      btnCheckUpdate.onclick = () => {
        btnCheckUpdate.disabled = true;
        btnCheckUpdate.textContent = 'Suche nach Update…';
        loadUpdateStatus(true).finally(() => {
          btnCheckUpdate.disabled = false;
          if (btnRunUpdate && !btnRunUpdate.disabled) {
            btnCheckUpdate.textContent = btnCheckDefaultText || 'Nach Update suchen';
          } else {
            btnCheckUpdate.textContent = btnCheckDefaultText || 'Nach Update suchen';
          }
        });
      };
    }
    if (btnRunUpdate) {
      btnRunUpdate.onclick = async () => {
        if (btnRunUpdate.disabled) return;
        const confirmed = await showConfirmModal('Docker-Compose Stack jetzt aktualisieren? Die Dienste werden kurzzeitig neu gestartet.');
        if (!confirmed) return;
        const pw = await askAdminPassword();
        if (!pw) return;
        const fd = new FormData();
        fd.append('pw', pw);
        try {
          const response = await fetch('/api/update/run', { method: 'POST', body: fd });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const detail = data.detail || data.error || response.statusText || response.status;
            showInfoModal('Update fehlgeschlagen', detail ? String(detail) : 'Update konnte nicht gestartet werden.', 'error');
            return;
          }
          openUpdateProgressModal('Update wird vorbereitet…');
          setUpdateModalLogContent([
            'Update-Runner wird gestartet…',
            'Docker Compose wird neu gebaut. Bitte diese Ansicht geöffnet lassen.'
          ]);
          scheduleUpdateReload();
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          showInfoModal('Update fehlgeschlagen', message, 'error');
        } finally {
          loadUpdateStatus(true).catch(() => {});
          loadHealthSummary(false).catch(() => {});
        }
      };
    }

    if (btnCheckOsUpdates) {
      btnCheckOsUpdates.onclick = async () => {
        if (btnCheckOsUpdates.disabled) return;
        btnCheckOsUpdates.disabled = true;
        btnCheckOsUpdates.classList.add('opacity-60', 'cursor-not-allowed');
        btnCheckOsUpdates.textContent = 'Prüfe Pakete…';
        await loadOsUpdateStatus(true);
      };
    }

    if (btnApplyOsUpdates) {
      btnApplyOsUpdates.onclick = async () => {
        if (btnApplyOsUpdates.disabled) return;
        const confirmed = await showConfirmModal('Verfügbare Systemupdates jetzt installieren? Der Vorgang kann einige Minuten dauern.');
        if (!confirmed) return;
        const pw = await askAdminPassword();
        if (!pw) return;
        const fd = new FormData();
        fd.append('pw', pw);
        btnApplyOsUpdates.disabled = true;
        btnApplyOsUpdates.classList.add('opacity-60', 'cursor-not-allowed');
        btnApplyOsUpdates.textContent = 'Installation läuft…';
        try {
          const response = await fetch('/api/os-updates/apply', { method: 'POST', body: fd });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const detail = data.detail || data.error || response.statusText || response.status;
            throw new Error(detail ? String(detail) : 'Systemupdate konnte nicht gestartet werden.');
          }
          showInfoModal('Systemupdate gestartet', 'Pakete werden im Hintergrund aktualisiert. Dieser Vorgang kann einige Minuten dauern.');
          await loadOsUpdateStatus(true);
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          showInfoModal('Systemupdate fehlgeschlagen', message, 'error');
          await loadOsUpdateStatus(false);
        }
      };
    }

    if (btnSaveAuto) {
      btnSaveAuto.onclick = async () => {
        if (btnSaveAuto.disabled) return;
        const pw = await askAdminPassword();
        if (!pw) return;
        const fd = new FormData();
        fd.append('pw', pw);
        fd.append('auto_enabled', autoUpdateToggle && autoUpdateToggle.checked ? '1' : '0');
        fd.append('auto_hour', autoUpdateHour ? autoUpdateHour.value : '1');
        try {
          const response = await fetch('/api/update/config', { method: 'POST', body: fd });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || !data.ok) {
            const detail = data.detail || data.error || response.statusText || response.status;
            alert('Konfiguration konnte nicht gespeichert werden: ' + detail);
            return;
          }
          alert('Auto-Update-Einstellungen gespeichert.');
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          alert('Fehler beim Speichern der Auto-Update-Einstellungen: ' + message);
        } finally {
          loadUpdateStatus(true).catch(() => {});
        }
      };
    }

    hydrateLicenseTimestamp();
    hydrateShooterTimestamp();
    loadOsUpdateStatus(false).catch(() => {});
    loadUpdateStatus(false).catch(() => {});
    loadHealthSummary(false).catch(() => {});
  </script>
</body>
</html>
