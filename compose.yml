name: connector
services:
  redpanda:
    image: redpandadata/redpanda:v24.1.10
    container_name: ts-redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp=1
      - --memory=256M
      - --reserve-memory=0M
      - --check=false
      - --kafka-addr=PLAINTEXT://0.0.0.0:9092
      - --advertise-kafka-addr=PLAINTEXT://redpanda:9092
    restart: unless-stopped
    ports:
      - "9092:9092"  # optional für Debug von außen

  schema-registry:
    image: confluentinc/cp-schema-registry:7.7.0
    container_name: ts-schema-registry
    restart: unless-stopped
    environment:
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://redpanda:9092
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
      SCHEMA_REGISTRY_KAFKASTORE_TOPIC: _schemas
    depends_on:
      - redpanda
    ports:
      - "8081:8081"  # optional für Debug und Troubleshooting

  kafka-connect:
    build:
      context: ./connect
    container_name: ts-kafka-connect
    restart: unless-stopped
    ports:
      - "8083:8083"             # Connect REST (nur intern nutzen)
    environment:
      # Worker nutzt NUR den lokalen Broker (damit immer startbar)
      CONNECT_BOOTSTRAP_SERVERS: redpanda:9092
      CONNECT_REST_ADVERTISED_HOST_NAME: kafka-connect
      CONNECT_GROUP_ID: targetshot-connect
      CONNECT_CONFIG_STORAGE_TOPIC: _ts_connect_configs
      CONNECT_OFFSET_STORAGE_TOPIC: _ts_connect_offsets
      CONNECT_STATUS_STORAGE_TOPIC: _ts_connect_status
      # Single-Node => RF=1 (wichtig!)
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1

      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_PLUGIN_PATH: /usr/share/java,/usr/share/confluent-hub-components

      # Config Provider (Secrets aus Datei)
      CONNECT_CONFIG_PROVIDERS: file
      CONNECT_CONFIG_PROVIDERS_FILE_CLASS: org.apache.kafka.common.config.provider.FileConfigProvider
      SECRETS_FILE: /app/data/secrets.properties

      CONNECT_REST_PORT: 8083
      CONNECT_LOG4J_ROOT_LOGLEVEL: INFO
      CONNECT_SCHEMA_REGISTRY_URL: http://schema-registry:8081
    volumes:
      - ./ui/data:/app/data   # Connect liest hier die secrets.properties
    depends_on:
      - redpanda
      - schema-registry
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8083/connectors"]
      interval: 15s
      timeout: 5s
      retries: 5

  mirror-maker:
    image: confluentinc/cp-kafka:7.7.0
    container_name: ts-mirror-maker
    restart: unless-stopped
    environment:
      KAFKA_LOG4J_ROOT_LOGLEVEL: INFO
    entrypoint: /bin/bash
    command: >
      -lc "
      while [ ! -f /app/data/mm2.properties ]; do
        echo 'Warte auf MirrorMaker-Konfiguration...';
        sleep 5;
      done;
      exec connect-mirror-maker /app/data/mm2.properties
      "
    volumes:
      - ./ui/data:/app/data
    depends_on:
      - redpanda

  streams-transform:
    build:
      context: ./streams
    container_name: ts-streams-transform
    restart: unless-stopped
    environment:
      STREAMS_BOOTSTRAP_SERVERS: redpanda:9092
      STREAMS_TARGET_PREFIX: ${TS_STREAMS_TARGET_PREFIX:-ts.sds-test}
      STREAMS_APPLICATION_ID: ${TS_STREAMS_APPLICATION_ID:-ts-streams-transform}
      STREAMS_INPUT_PATTERN: ${TS_STREAMS_INPUT_PATTERN:-^[0-9]+\\.SMDB\\.(Schuetze|Treffer|Scheiben|Serien)$}
      STREAMS_NUM_THREADS: ${TS_STREAMS_NUM_THREADS:-1}
      STREAMS_COMMIT_INTERVAL_MS: ${TS_STREAMS_COMMIT_INTERVAL_MS:-5000}
    depends_on:
      - redpanda

  backup-db:
    image: postgres:16-alpine
    container_name: ts-backup-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${TS_CONNECT_BACKUP_DB:-targetshot_backup}
      POSTGRES_USER: ${TS_CONNECT_BACKUP_USER:-targetshot}
      POSTGRES_PASSWORD: ${TS_CONNECT_BACKUP_PASSWORD:-targetshot}
    volumes:
      - ./ui/data/backup-db:/var/lib/postgresql/data
    ports:
      - "${TS_CONNECT_BACKUP_PORT:-5432}:5432"

  ui:
    build:
      context: ./ui
    image: ${TS_CONNECT_UI_IMAGE:-targetshot.azurecr.io/ts-connect:stable}
    container_name: ts-connect-ui
    restart: unless-stopped
    # Nur im Vereinsnetz freigeben: UI_BIND_IP z.B. 192.168.11.5
    ports:
      - "${UI_BIND_IP:-0.0.0.0}:8080:8080"
    environment:
      UI_ADMIN_PASSWORD: ${UI_ADMIN_PASSWORD:-change-me}
      CONNECT_BASE_URL: http://kafka-connect:8083
      DEFAULT_CONNECTOR_NAME: targetshot-debezium
      UI_TRUSTED_CIDRS: ${UI_TRUSTED_CIDRS:-192.168.0.0/16,10.0.0.0/8,172.16.0.0/12}
      COMPOSE_PROJECT_NAME: ${COMPOSE_PROJECT_NAME:-ts-connect}
      TS_CONNECT_WORKSPACE: /workspace
      TS_CONNECT_DATA_DIR: /app/data
      TS_CONNECT_UI_IMAGE: ${TS_CONNECT_UI_IMAGE:-targetshot.azurecr.io/ts-connect:stable}
      TS_CONNECT_ACR_REGISTRY: ${TS_CONNECT_ACR_REGISTRY:-}
      TS_CONNECT_ACR_USERNAME: ${TS_CONNECT_ACR_USERNAME:-}
      TS_CONNECT_ACR_PASSWORD: ${TS_CONNECT_ACR_PASSWORD:-}
      ELASTIC_AGENT_ENABLED: ${ELASTIC_AGENT_ENABLED:-false}
      TS_CONNECT_UPDATE_AGENT_URL: ${TS_CONNECT_UPDATE_AGENT_URL:-http://127.0.0.1:9000}
      TS_CONNECT_UPDATE_AGENT_TOKEN: ${TS_CONNECT_UPDATE_AGENT_TOKEN:-}
    depends_on:
      - kafka-connect
    volumes:
      - ./ui/data:/app/data
      - type: bind
        source: ${TS_CONNECT_WORKSPACE_HOST:-.}
        target: /workspace
      - /var/run/docker.sock:/var/run/docker.sock

  elastic-agent:
    profiles:
      - elastic
    image: docker.elastic.co/beats/elastic-agent:8.15.3
    container_name: ts-elastic-agent
    restart: unless-stopped
    user: root
    environment:
      FLEET_ENROLL: "1"
      FLEET_URL: ${ELASTIC_FLEET_URL}
      FLEET_ENROLLMENT_TOKEN: ${ELASTIC_FLEET_ENROLLMENT_TOKEN}
      ELASTIC_AGENT_TAGS: ${ELASTIC_AGENT_TAGS:-site:unknown,tier:unknown}
      ELASTIC_AGENT_LOG_LEVEL: ${ELASTIC_AGENT_LOG_LEVEL:-info}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./ui/data:/app/data
      - ./elastic-agent/state:/usr/share/elastic-agent/state
    depends_on:
      - ui

volumes: {}
