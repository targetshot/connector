name: Release ts-connect

on:
  release:
    types: [published]

env:
  IMAGE_NAME: ts-connect
  ACR_NAME: targetshot
  REGISTRY: targetshot.azurecr.io
  VERSION: ${{ github.event.release.tag_name }}

jobs:
  build-push-sign:
    environment: release
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure version value
        run: |
          if [ -z "${VERSION}" ]; then
            echo "Release tag missing" >&2
            exit 1
          fi
          echo "Building version ${VERSION}"

      - name: Validate registry settings
        run: |
          if [ -z "${ACR_NAME}" ]; then
            echo "ACR_NAME secret not configured" >&2
            exit 1
          fi
          if [ -z "${REGISTRY}" ]; then
            echo "REGISTRY value missing" >&2
            exit 1
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Force correct subscription
        run: az account set --subscription "e4d628f6-ede4-4af9-8310-b25724a71961"

      - name: Verify Azure context
        run: |
          az account show --query "{sub:id, name:name}" -o table
          az acr show --subscription "e4d628f6-ede4-4af9-8310-b25724a71961" -n "${ACR_NAME}" -o table

      - name: Login to ACR
        run: az acr login --subscription "e4d628f6-ede4-4af9-8310-b25724a71961" --name "${ACR_NAME}"

      - name: Build and push multi-arch image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ui
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image digest
        env:
          COSIGN_EXPERIMENTAL: "true"
          IMAGE_REF: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build.outputs.digest }}
        run: cosign sign --yes ${IMAGE_REF}

      - name: Tag release as beta
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          set -eux
          az acr import \
            --subscription "e4d628f6-ede4-4af9-8310-b25724a71961" \
            --name "${ACR_NAME}" \
            --source "${REGISTRY}/${IMAGE_NAME}@${DIGEST}" \
            --image "${IMAGE_NAME}:beta" \
            --force
