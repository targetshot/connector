name: Promote ts-connect image

on:
  workflow_dispatch:
    inputs:
      source:
        description: "Version tag or digest (sha256:...) to promote"
        required: true
      channel:
        description: "Channel tag"
        required: true
        type: choice
        default: stable
        options:
          - beta
          - stable
          - lts

permissions:
  contents: read
  id-token: write

env:
  IMAGE_NAME: ts-connect
  ACR_NAME: targetshot
  REGISTRY: targetshot.azurecr.io
  AZURE_SUBSCRIPTION_ID: e4d628f6-ede4-4af9-8310-b25724a71961
  AZURE_EXTENSION_USE_DYNAMIC_INSTALL: yes_without_prompt

jobs:
  promote:
    environment: release
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Force correct subscription
        run: az account set --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}"

      - name: Verify Azure context
        run: |
          az account show --query "{sub:id, name:name}" -o table
          az acr show --subscription "${{ env.AZURE_SUBSCRIPTION_ID }}" -n "${ACR_NAME}" -o table

      - name: Resolve digest
        id: resolve
        env:
          SOURCE: ${{ github.event.inputs.source }}
        run: |
          set -euo pipefail
          if [[ "${SOURCE}" == sha256:* ]]; then
            DIGEST="${SOURCE}"
          else
            echo "Resolving digest for tag ${SOURCE}"
            DIGEST=$(az acr repository show \
              --subscription "${AZURE_SUBSCRIPTION_ID}" \
              --name "${ACR_NAME}" \
              --image "${IMAGE_NAME}:${SOURCE}" \
              --query digest -o tsv)
          fi
          if [ -z "${DIGEST}" ]; then
            echo "Unable to resolve digest for ${SOURCE}" >&2
            exit 1
          fi
          echo "digest=${DIGEST}" >> "$GITHUB_OUTPUT"

      - name: Promote to channel
        env:
          DIGEST: ${{ steps.resolve.outputs.digest }}
          CHANNEL: ${{ github.event.inputs.channel }}
        run: |
          set -eux
          az acr import \
            --subscription "${AZURE_SUBSCRIPTION_ID}" \
            --name "${ACR_NAME}" \
            --source "${REGISTRY}/${IMAGE_NAME}@${DIGEST}" \
            --image "${IMAGE_NAME}:${CHANNEL}" \
            --force
          echo "Promoted ${DIGEST} to ${CHANNEL}"

      - name: Determine promoted version
        id: version
        env:
          DIGEST: ${{ steps.resolve.outputs.digest }}
          SOURCE_INPUT: ${{ github.event.inputs.source }}
        run: |
          set -euo pipefail
          VERSION=$(az acr manifest show-metadata \
            --subscription "${AZURE_SUBSCRIPTION_ID}" \
            --name "${ACR_NAME}" \
            --image "${IMAGE_NAME}@${DIGEST}" \
            --query 'metadata.annotations."org.opencontainers.image.version"' \
            -o tsv)
          if [[ -z "${VERSION}" || "${VERSION}" == "None" ]]; then
            VERSION="${SOURCE_INPUT}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Annotate promoted channel
        env:
          CHANNEL: ${{ github.event.inputs.channel }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          set -eux
          az acr manifest update \
            --subscription "${AZURE_SUBSCRIPTION_ID}" \
            --name "${ACR_NAME}" \
            --repository "${IMAGE_NAME}" \
            --tag "${CHANNEL}" \
            --set metadata.annotations."org.opencontainers.image.version"="${VERSION}"
